---
title: "Splitting St Paul's Parish in Half"
author: "Dave & Shiobhan"
format: html
editor: visual
---

## Introduction

## Libraries

```{r libraries}
library(conflicted)

library(fs)
library(here)

library(sf)
library(ggplot2)
library(dplyr)
conflicted::conflicts_prefer(dplyr::filter)
library(vroom)
library(stringr)
```

## Load Data

```{r load_data}
#| cache: true
parish_query <-
  "SELECT parish_code, parish_name FROM \"coe-parishes_2022\" WHERE parish_code = 550049"

parish <- read_sf(here("parish-shapes", "coe-parishes_2022.geojson"),
                  query = parish_query)

llsoa <- read_sf(here("civic-areas",
                      "2011_lsoa-boundaries_england-wales_generalised-clipped"))

oa <- read_sf(here("civic-areas",
                   "2021_oa-boundaries_england-wales_generalised_clipped"))

imd <- vroom(here("small-area-stats", "imd_2019.csv"),
             col_types = "ccccii")
```

## Clean data

```{r clean_data}
oa <-
  select(oa, oa_2021_code = OA21CD) |> 
  filter(str_starts(oa_2021_code, "E"))

llsoa <-
  select(llsoa, lsoa_2011_code = LSOA11CD, lon = LONG, lat = LAT) |> 
  filter(str_starts(lsoa_2011_code, "E"))

english_imd <- 
  select(
    imd, 
    lsoa_2011_code = `LSOAcode(2011)`,
    imd_rank = `IndexofMultipleDeprivation(IMD) Rank`,
    imd_decile = `IndexofMultipleDeprivation(IMD)Decile` 
    ) |> 
  filter(str_starts(lsoa_2011_code, "E"))

rm(imd)
```

## Find intersecting LLSOA

### Reproject parish shape

We need to reproject `parish` using (`st_transform`) so that it shares the same projection as `llsoa`. This will enable us to find those LLSOA that intersect the parish.

```{r reproject_parish}
parish <- st_transform(parish, crs = st_crs(llsoa))
```

### Find intersecting LLSOA

Use `st_intersects()` to determine which LLSOA intersect the parish

```{r find_intersecting_llsoa}
intersecting_llsoa <-
  st_intersects(llsoa, parish, sparse = FALSE) |> 
  as.vector()

llsoa <- filter(llsoa, intersecting_llsoa)
```

## Join IMD data to LLSOA

`left_join()` IMD data to `llsoa` by LLSOA code

## Plot LLSOA IMD and code

```{r plot_llsoa_imd_and_code}
ggplot(llsoa) +
  geom_sf(colour = "black", fill = "white") + 
  geom_sf_text(aes(label = lsoa_2011_code))
```
